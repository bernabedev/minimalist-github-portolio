---
import SunIcon from '@icons/sun.astro'
import MoonIcon from '@icons/moon.astro'
---

<!-- Inline script in the head to apply theme immediately -->
<script is:inline>
  function applyTheme() {
    // Get system preference
    const getSystemPreference = () => {
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    }

    // Check localStorage first, then fall back to system preference
    const savedTheme = localStorage.getItem('theme') || 'system'

    // Apply system or saved theme
    let isDark = false
    if (savedTheme === 'system') {
      isDark = getSystemPreference() === 'dark'
    } else {
      isDark = savedTheme === 'dark'
    }

    // Apply before page renders
    if (isDark) {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  }

  // Execute immediately
  applyTheme()
</script>

<script>
  const initThemeToggle = () => {
    const themeToggleBtn = document.getElementById('theme-toggle-btn')
    const sunIcon = document.getElementById('light')
    const moonIcon = document.getElementById('dark')

    const toggleTheme = () => {
      const isDark = document.documentElement.classList.toggle('dark')
      localStorage.setItem('theme', isDark ? 'dark' : 'light')
      updateIcons(isDark)
    }

    const updateIcons = (isDark: boolean) => {
      if (sunIcon) {
        sunIcon.style.opacity = isDark ? '0' : '1'
      }
      if (moonIcon) {
        moonIcon.style.opacity = isDark ? '1' : '0'
      }
    }

    // Get system preference
    const getSystemPreference = () => {
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    }

    // Set initial icon state
    const savedTheme = localStorage.getItem('theme') || 'system'
    let isDark = false
    if (savedTheme === 'system') {
      isDark = getSystemPreference() === 'dark'
    } else {
      isDark = savedTheme === 'dark'
    }

    updateIcons(isDark)

    // Listen for system theme changes if using system theme
    window
      .matchMedia('(prefers-color-scheme: dark)')
      .addEventListener('change', (e) => {
        if (localStorage.getItem('theme') === 'system') {
          const newIsDark = e.matches
          document.documentElement.classList.toggle('dark', newIsDark)
          updateIcons(newIsDark)
        }
      })

    themeToggleBtn?.addEventListener('click', toggleTheme)
  }

  if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', initThemeToggle)
  }
</script>

<div class='relative'>
  <button
    id='theme-toggle-btn'
    class='flex appearance-none border-none transition hover:scale-125'
  >
    <span class='sr-only'>Elige el tema</span>
    <SunIcon id='light' class='theme-toggle-icon size-5 transition-all' />
    <MoonIcon
      id='dark'
      class='theme-toggle-icon absolute size-5 transition-all'
    />
  </button>
</div>

<style>
  .theme-toggle-icon {
    transition: opacity 0.3s ease-in-out;
  }
</style>
